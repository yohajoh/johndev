[build]
  command = "pnpm run build"
  publish = ".next"
  functions = ".next/serverless"  # Add this for API routes

[build.environment]
  NODE_VERSION = "18"  # Explicitly set Node version
  NPM_FLAGS = "--version"  # Ensures pnpm works correctly
  NEXT_PRIVATE_TARGET = "server"  # Required for standalone output

[dev]
  command = "pnpm run dev"
  port = 3000
  publish = "public"

[[plugins]]
  package = "@netlify/plugin-nextjs"

  [plugins.inputs]
    functions = ".next/serverless"  # Tell plugin where functions are
    publish = ".next"

# Redirects for client-side routing (SPA fallback)
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# API routes proxy (important for API routes)
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200

# Ensure _next folder is accessible
[[headers]]
  for = "/_next/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"